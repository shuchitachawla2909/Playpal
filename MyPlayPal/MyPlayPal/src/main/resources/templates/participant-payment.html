<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment - MyPlayPal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    .payment-card {
        max-width: 600px;
        margin: 2rem auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
    .event-details {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 1.5rem;
    }
    .payment-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        padding: 12px 30px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    .payment-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    .loading-spinner {
        display: none;
    }
    .error-alert {
        display: none;
    }
    .success-alert {
        display: none;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="payment-card">
    <!-- Error Alert -->
    <div class="alert alert-danger error-alert" id="errorAlert" role="alert">
      <span id="errorMessage"></span>
    </div>

    <!-- Success Alert -->
    <div class="alert alert-success success-alert" id="successAlert" role="alert">
      <span id="successMessage"></span>
    </div>

    <!-- Server-side Error -->
    <div th:if="${error}" class="alert alert-warning" role="alert">
      <span th:text="${error}"></span>
    </div>

    <!-- Event Details -->
    <div class="event-details" th:if="${event}">
      <h2 class="text-center mb-4">Complete Your Payment</h2>
      <div class="row">
        <div class="col-md-6">
          <h4 th:text="${event.eventName}">Event Name</h4>
          <p class="mb-1"><strong>Venue:</strong>
            <span th:if="${event.venue != null}" th:text="${event.venue.venuename}"></span>
            <span th:unless="${event.venue != null}">Venue not specified</span>
          </p>
          <p class="mb-1"><strong>Skill Level:</strong>
            <span th:text="${event.skillLevelRequired != null} ? ${event.skillLevelRequired} : 'All Levels'">Beginner</span>
          </p>
          <p class="mb-1"><strong>Players:</strong>
            <span th:text="${event.currentPlayers != null} ? ${event.currentPlayers} : 0">0</span>/
            <span th:text="${event.maxPlayers != null} ? ${event.maxPlayers} : 10">10</span>
          </p>
        </div>
        <div class="col-md-6 text-end">
          <h3 class="text-warning">₹
            <span th:if="${event.entryFee != null}" th:text="${#numbers.formatDecimal(event.entryFee, 1, 2)}">0.00</span>
            <span th:unless="${event.entryFee != null}">0.00</span>
          </h3>
          <p class="mb-0"><small>Entry Fee</small></p>
        </div>
      </div>
    </div>

    <!-- Show message if event not found -->
    <div th:unless="${event}" class="alert alert-danger">
      <h4>Event Not Available</h4>
      <p>The event you're trying to join is not available or doesn't exist.</p>
      <a th:href="@{/events}" class="btn btn-primary">Browse Events</a>
    </div>

    <!-- Payment Form (only show if event exists) -->
    <div th:if="${event}" class="card-body">
      <form id="payment-form">
        <div class="mb-3">
          <label for="name" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="name"
                 th:value="${currentUser?.username != null} ? ${currentUser.username} : ''"
                 required readonly>
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <input type="email" class="form-control" id="email"
                 th:value="${currentUser?.email != null} ? ${currentUser.email} : ''"
                 required readonly>
        </div>

        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <input type="tel" class="form-control" id="phone"
                 th:value="${currentUser?.contact != null} ? ${currentUser.contact} : ''"
                 required readonly>
        </div>

        <div class="alert alert-info">
          <h6>Payment Summary</h6>
          <div class="d-flex justify-content-between">
            <span>Entry Fee:</span>
            <span>₹
              <span th:if="${event.entryFee != null}" th:text="${#numbers.formatDecimal(event.entryFee, 1, 2)}">0.00</span>
              <span th:unless="${event.entryFee != null}">0.00</span>
            </span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <span>Total Amount:</span>
            <span>₹
              <span th:if="${event.entryFee != null}" th:text="${#numbers.formatDecimal(event.entryFee, 1, 2)}">0.00</span>
              <span th:unless="${event.entryFee != null}">0.00</span>
            </span>
          </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" id="eventId" th:value="${event?.id}">
        <input type="hidden" id="userId" th:value="${currentUser?.id}">
        <input type="hidden" id="amount" th:value="${event?.entryFee != null} ? ${event.entryFee} : 0">

        <div class="text-center">
          <button type="button" class="btn payment-btn" id="payButton" onclick="initiatePayment()">
            <span class="spinner-border spinner-border-sm loading-spinner" id="loadingSpinner" role="status"></span>
            Pay Now - ₹
            <span th:if="${event.entryFee != null}" th:text="${#numbers.formatDecimal(event.entryFee, 1, 2)}">0.00</span>
            <span th:unless="${event.entryFee != null}">0.00</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Global variables to track payment state
  let paymentInProgress = false;
  let currentParticipantId = null;

  // Function to show error message
  function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    const errorMessage = document.getElementById('errorMessage');
    if (errorAlert && errorMessage) {
      errorMessage.textContent = message;
      errorAlert.style.display = 'block';
      hideSuccess();
    }
  }

  // Function to hide error message
  function hideError() {
    const errorAlert = document.getElementById('errorAlert');
    if (errorAlert) {
      errorAlert.style.display = 'none';
    }
  }

  // Function to show success message
  function showSuccess(message) {
    const successAlert = document.getElementById('successAlert');
    const successMessage = document.getElementById('successMessage');
    if (successAlert && successMessage) {
      successMessage.textContent = message;
      successAlert.style.display = 'block';
      hideError();
    }
  }

  // Function to hide success message
  function hideSuccess() {
    const successAlert = document.getElementById('successAlert');
    if (successAlert) {
      successAlert.style.display = 'none';
    }
  }

  // Function to safely update button state
  function updateButtonState(loading, text = null) {
    try {
      const button = document.getElementById('payButton');
      const spinner = document.getElementById('loadingSpinner');

      if (!button) {
        console.warn('Pay button not found');
        return;
      }

      if (loading) {
        button.disabled = true;
        if (spinner) {
          spinner.style.display = 'inline-block';
        }
        if (text) {
          button.innerHTML = '<span class="spinner-border spinner-border-sm loading-spinner" id="loadingSpinner" role="status"></span> ' + text;
        }
      } else {
        button.disabled = false;
        if (spinner) {
          spinner.style.display = 'none';
        }
        // Reset button text
        const amount = document.getElementById('amount')?.value || '0.00';
        button.innerHTML = '<span class="spinner-border spinner-border-sm loading-spinner" id="loadingSpinner" role="status"></span> Pay Now - ₹' + parseFloat(amount).toFixed(2);
      }
    } catch (error) {
      console.error('Error updating button state:', error);
    }
  }

  // Function to initiate Razorpay payment
  function initiatePayment() {
    if (paymentInProgress) {
      console.log('Payment already in progress');
      return;
    }

    const eventId = document.getElementById('eventId')?.value;
    const userId = document.getElementById('userId')?.value;
    const amount = document.getElementById('amount')?.value;

    if (!eventId || !userId || !amount) {
      showError('Missing required information. Please refresh the page and try again.');
      return;
    }

    paymentInProgress = true;
    hideError();
    hideSuccess();
    updateButtonState(true, 'Creating Order...');

    console.log('Initiating payment for event:', eventId, 'user:', userId, 'amount:', amount);

    // Create order via participant payment endpoint
    fetch('/api/participant-payment/create-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        eventId: eventId,
        userId: userId,
        amount: amount
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('Order creation response:', data);

      if (data.id && data.amount && data.participantId) {
        currentParticipantId = data.participantId;

        const options = {
          key: 'rzp_test_RaUdqlIGoEQOFj', // Your Razorpay key
          amount: data.amount,
          currency: 'INR',
          name: 'MyPlayPal',
          description: 'Event Participation Fee',
          order_id: data.id,
          handler: function (response) {
            console.log('Payment successful:', response);
            handlePaymentSuccess(response);
          },
          prefill: {
            name: document.getElementById('name')?.value || '',
            email: document.getElementById('email')?.value || '',
            contact: document.getElementById('phone')?.value || ''
          },
          theme: {
            color: '#667eea'
          },
          modal: {
            ondismiss: function() {
              console.log('Payment modal dismissed');
              paymentInProgress = false;
              updateButtonState(false);
            }
          }
        };

        const razorpay = new Razorpay(options);
        razorpay.open();
        updateButtonState(false);
      } else {
        throw new Error(data.error || data.message || 'Failed to create payment order');
      }
    })
    .catch(error => {
      console.error('Error creating order:', error);
      showError('Error creating payment order: ' + error.message);
      paymentInProgress = false;
      updateButtonState(false);
    });
  }

  // Function to handle successful payment
  function handlePaymentSuccess(paymentResponse) {
    console.log('Handling payment success:', paymentResponse);

    if (!currentParticipantId) {
      showError('Payment information incomplete. Please contact support.');
      paymentInProgress = false;
      return;
    }

    showSuccess('Payment received! Verifying...');

    // Verify payment with participant payment endpoint
    fetch('/api/participant-payment/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        paymentId: paymentResponse.razorpay_payment_id,
        orderId: paymentResponse.razorpay_order_id,
        signature: paymentResponse.razorpay_signature,
        participantId: currentParticipantId
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      console.log('Payment verification response:', data);

      if (data.status === 'success') {
        showSuccess('Payment verified successfully! Redirecting...');
        // Redirect to success page after a short delay
        setTimeout(() => {
          window.location.href = '/api/participant-payment/success?participantId=' +
            currentParticipantId +
            '&paymentId=' + paymentResponse.razorpay_payment_id;
        }, 1500);
      } else {
        throw new Error(data.message || 'Payment verification failed');
      }
    })
    .catch(error => {
      console.error('Error verifying payment:', error);
      showError('Payment verification failed: ' + error.message);
      paymentInProgress = false;
    });
  }

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Payment page loaded');
    updateButtonState(false);
  });
</script>
</body>
</html>