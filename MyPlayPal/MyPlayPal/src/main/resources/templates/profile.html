<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Profile - PlayPal</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <i class="fas fa-futbol"></i>
            <span>PlayPal</span>
        </div>
        <div class="nav-menu" id="nav-menu">
            <a th:href="@{/}" class="nav-link">Home</a>
            <a th:href="@{/venues}" class="nav-link">Book</a>
            <a th:href="@{/events}" class="nav-link">Events</a>
            <a th:href="@{/games}" class="nav-link">Games</a>
            <a th:href="@{/about}" class="nav-link">About</a>
            <a th:href="@{/contact}" class="nav-link">Contact</a>
            <!-- start: replace this block inside your nav -->
            <div class="nav-auth" id="nav-auth">
                <!-- When authenticated, show profile + logout -->
                <div sec:authorize="isAuthenticated()" class="mydiv">

                    <a sec:authorize="hasRole('USER')" th:href="@{/profile}" class="nav-link">
                        <img th:src="${currentUser != null and currentUser.profilePictureUrl != null} ?
              ${currentUser.profilePictureUrl} :
              @{/images/default-avatar.jpeg}"
                             alt="Profile" class="nav-avatar">
                    </a>

                    <a sec:authorize="hasRole('MANAGER')" th:href="@{/manager/profile}" class="nav-link">
                        <img th:src="@{/images/default-avatar.jpeg}" alt="Manager Profile" class="nav-avatar">
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline-block">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="nav-link logout-btn">
                            Logout
                        </button>
                    </form>
                </div>

                <!-- when not authenticated show login/signup -->
                <div th:unless="${authenticated}">
                    <a th:href="@{/login}" class="nav-link login-btn">Login</a>
                    <a th:href="@{/signup}" class="signup-link signup-btn active">Sign Up</a>
                </div>
            </div>
            <!-- end: replace -->

        </div>
        <div class="nav-hamburger" id="nav-hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</nav>


<section class="profile-section">
    <div class="container" style="max-width: 1000px;">

        <!-- Profile Info -->
        <div style="background-color: var(--white); padding: 40px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 40px;">
            <h2>Your Profile</h2>
            <div style="text-align: center; margin: 20px 0;">
                <img th:src="${user.profilePictureUrl != null} ? ${user.profilePictureUrl} : @{/images/default-avatar.jpeg}"
                     alt="avatar"
                     style="width:100px;height:100px;border-radius:50%; border: 3px solid var(--secondary-color); object-fit: cover;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <p><strong>Username:</strong> <span th:text="${user.username}"></span></p>
                <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>
                <p><strong>Contact:</strong> <span th:text="${user.contact}"></span></p>
                <p><strong>City:</strong> <span th:text="${user.city}"></span></p>
                <p><strong>State:</strong> <span th:text="${user.state}"></span></p>
                <p><strong>Age:</strong> <span th:text="${user.age}"></span></p>
            </div>
        </div>

        <!-- Events Created & Joined -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <!-- Events Created -->
            <div style="background-color: var(--white); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                <h2 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px;">
                    <i class="fas fa-calendar-plus"></i> Events Created
                </h2>
                <div th:if="${eventsCreated != null and !eventsCreated.isEmpty()}">
                    <div th:each="event : ${eventsCreated}"
                         style="background-color: var(--light-bg); padding: 15px; margin-bottom: 15px; border-radius: var(--border-radius);">
                        <h4 style="margin: 0 0 10px 0;">
                            <a th:href="@{/events/{id}(id=${event.id})}"
                               style="color: var(--heading-color); text-decoration: none;">
                                <span th:text="${event.eventName}">Event Name</span>
                            </a>
                        </h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: var(--text-color);">
                            <i class="fas fa-users"></i>
                            <span th:text="${event.currentPlayers} + '/' + ${event.maxPlayers}">5/10</span> players
                        </p>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: var(--text-color);">
                            <i class="fas fa-rupee-sign"></i> ₹<span th:text="${event.entryFee}">200</span>
                        </p>
                    </div>
                </div>
                <p th:if="${eventsCreated == null or eventsCreated.isEmpty()}"
                   style="text-align: center; color: var(--text-color); padding: 20px;">
                    <i class="fas fa-calendar-times"
                       style="font-size: 2rem; color: #ccc; display: block; margin-bottom: 10px;"></i>
                    No events created yet.
                </p>
            </div>

            <!-- Events Joined -->
            <div style="background-color: var(--white); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
                <h2 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px;">
                    <i class="fas fa-user-check"></i> Events Joined
                </h2>
                <div th:each="event : ${eventsJoined}"
                     style="background-color: var(--light-bg); padding: 15px; margin-bottom: 15px; border-radius: var(--border-radius);">
                    <h4 style="margin: 0 0 10px 0;">
                        <a th:href="@{/events/{id}(id=${event.id})}"
                           style="color: var(--heading-color); text-decoration: none;">
                            <span th:text="${event.eventName}">Event Name</span>
                        </a>
                    </h4>
                    <p style="margin: 5px 0; font-size: 0.9rem; color: var(--text-color);">
                        <i class="fas fa-user"></i> Organizer:
                        <span th:text="${event.organizer.username}">Organizer</span>
                    </p>
                    <p style="margin: 5px 0; font-size: 0.9rem; color: var(--text-color);">
                        <i class="fas fa-users"></i>
                        <span th:text="${event.currentPlayers} + '/' + ${event.maxPlayers}">5/10</span> players
                    </p>
                    <p style="margin: 5px 0; font-size: 0.9rem; color: var(--text-color);">
                        <i class="fas fa-rupee-sign"></i> ₹<span th:text="${event.entryFee}">200</span>
                    </p>
                </div>
                <p th:if="${eventsJoined == null or eventsJoined.isEmpty()}"
                   style="text-align: center; color: var(--text-color); padding: 20px;">
                    <i class="fas fa-calendar-times"
                       style="font-size: 2rem; color: #ccc; display: block; margin-bottom: 10px;"></i>
                    No events joined yet.
                </p>
            </div>
        </div>

        <!-- My Bookings -->
        <div style="background-color: var(--white); margin-top: 40px; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--box-shadow);">
            <h2 style="color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px;">
                <i class="fas fa-ticket-alt"></i> My Bookings
            </h2>

            <!-- ✅ Display bookings if available -->
            <div th:if="${userBookings != null and !userBookings.isEmpty()}">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead style="background-color: var(--secondary-color); color: white;">
                    <tr>
                        <th style="padding: 10px;">Court</th>
                        <th style="padding: 10px;">Date</th>
                        <th style="padding: 10px;">Start Time</th>
                        <th style="padding: 10px;">End Time</th>
                        <th style="padding: 10px;">Amount</th>
                        <th style="padding: 10px;">Status</th>
                        <th style="padding: 10px;">Actions</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="booking : ${userBookings}" style="background-color: var(--light-bg); text-align: center;">
                        <td style="padding: 10px;" th:text="${booking.courtname}">Court A</td>
                        <td style="padding: 10px;" th:text="${#temporals.format(booking.bookingDate, 'dd-MM-yyyy')}">30-10-2025</td>
                        <td style="padding: 10px;" th:text="${#temporals.format(booking.startTime, 'HH:mm')}">07:00</td>
                        <td style="padding: 10px;" th:text="${#temporals.format(booking.endTime, 'HH:mm')}">08:00</td>
                        <td style="padding: 10px;">₹<span th:text="${booking.totalAmount}">200</span></td>
                        <td style="padding: 10px;" th:text="${booking.status}">CONFIRMED</td>

                        <td style="padding: 10px;">
                            <button type="button"
                                    th:if="${booking.status == 'CONFIRMED'}"
                                    th:attr="data-booking-id=${booking.id}, data-booking-name=${booking.courtname}"
                                    onclick="openCancelModal(this)"
                                    style="background-color: #ff4d4d; color: white; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s;">
                                Cancel
                            </button>

                            <span th:if="${booking.status != 'CONFIRMED'}"
                                  style="color: gray; font-style: italic;">N/A</span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- 🚫 If no bookings -->
            <p th:if="${userBookings == null or userBookings.isEmpty()}"
               style="text-align: center; color: var(--text-color); padding: 20px;">
                <i class="fas fa-calendar-times"
                   style="font-size: 2rem; color: #ccc; display: block; margin-bottom: 10px;"></i>
                You have no bookings yet.
            </p>
        </div>

        <!-- 🔹 Custom Modal for Confirmation -->
        <div id="cancelModal" class="custom-modal">
            <div class="modal-content">
                <h3>Cancel Booking?</h3>
                <p id="cancelModalText"></p>
                <div class="modal-buttons">
                    <button id="confirmCancelBtn" class="confirm-btn">Yes, Cancel</button>
                    <button onclick="closeModal()" class="cancel-btn">No</button>
                </div>
            </div>
        </div>

        <!-- 🔹 Success Modal -->
        <div id="successModal" class="custom-modal">
            <div class="modal-content">
                <h3 style="color: var(--primary-color);">Booking Cancelled</h3>
                <p id="successModalText"></p>
                <div class="modal-buttons">
                    <button onclick="closeModal()" class="confirm-btn">OK</button>
                </div>
            </div>
        </div>

        <!-- 🔹 Modal Styling -->
        <style>
            .custom-modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0; top: 0;
                width: 100%; height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                align-items: center; justify-content: center;
            }

            .modal-content {
                background: white;
                padding: 25px;
                border-radius: 12px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                width: 320px;
                text-align: center;
                animation: slideDown 0.3s ease;
            }

            .modal-buttons {
                margin-top: 20px;
                display: flex;
                justify-content: space-around;
            }

            .confirm-btn {
                background-color: var(--primary-color);
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
            }

            .cancel-btn {
                background-color: #ccc;
                color: black;
                border: none;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
            }

            @keyframes slideDown {
                from { transform: translateY(-10px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
        </style>

        <!-- 🔹 JS Logic -->
        <script>
            let currentBookingId = null;
            let currentBookingName = null;

            function openCancelModal(button) {
                currentBookingId = button.getAttribute("data-booking-id");
                currentBookingName = button.getAttribute("data-booking-name");

                document.getElementById("cancelModalText").textContent =
                    `Are you sure you want to cancel your booking for ${currentBookingName}?`;

                document.getElementById("cancelModal").style.display = "flex";
            }

            function closeModal() {
                document.querySelectorAll(".custom-modal").forEach(modal => modal.style.display = "none");
            }

            document.getElementById("confirmCancelBtn").addEventListener("click", async () => {
                try {
                    const response = await fetch(`/api/bookings/${currentBookingId}/cancel`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" }
                    });

                    if (response.ok) {
                        const row = document.querySelector(`[data-booking-id="${currentBookingId}"]`).closest("tr");
                        row.querySelector("td:nth-child(6)").textContent = "CANCELLED";
                        row.querySelector("button").remove();

                        closeModal();
                        document.getElementById("successModalText").textContent =
                            `${currentBookingName} has been cancelled successfully.`;
                        document.getElementById("successModal").style.display = "flex";
                    } else {
                        alert("Failed to cancel booking. Please try again.");
                    }
                } catch (error) {
                    alert("An error occurred: " + error.message);
                }
            });
        </script>

    </div>
</section>


</body>
</html>
