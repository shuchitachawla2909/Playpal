<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Court - PlayPal</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .step {
          cursor: pointer;
        }
        .step.active {
          color: var(--primary-color);
          border-bottom: 2px solid var(--secondary-color);
          padding-bottom: 5px;
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <i class="fas fa-futbol"></i>
            <span>PlayPal</span>
        </div>
        <div class="nav-menu" id="nav-menu">
            <a th:href="@{/}" class="nav-link">Home</a>
            <a th:href="@{/venues}" class="nav-link active">Book</a>
            <a th:href="@{/events}" class="nav-link">Events</a>
            <a th:href="@{/games}" class="nav-link">Games</a>
            <a th:href="@{/about}" class="nav-link">About</a>
            <a th:href="@{/contact}" class="nav-link">Contact</a>
            <!-- start: replace this block inside your nav -->
            <div class="nav-auth" id="nav-auth">
                <!-- When authenticated, show profile + logout -->
                <div sec:authorize="isAuthenticated()" class="mydiv">

                    <a sec:authorize="hasRole('USER')" th:href="@{/profile}" class="nav-link">
                        <img th:src="${currentUser!=null and currentUser.profilePictureUrl != null} ? ${currentUser.profilePictureUrl} : @{/images/default-avatar.jpeg}"
                             alt="Profile" class="nav-avatar">
                    </a>

                    <a sec:authorize="hasRole('MANAGER')" th:href="@{/manager/profile}" class="nav-link">
                        <img th:src="@{/images/default-avatar.jpeg}" alt="Manager Profile" class="nav-avatar">
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline-block">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="nav-link logout-btn">
                            Logout
                        </button>
                    </form>
                </div>

                <!-- when not authenticated show login/signup -->
                <div th:unless="${authenticated}">
                    <a th:href="@{/login}" class="nav-link login-btn">Login</a>
                    <a th:href="@{/signup}" class="signup-link signup-btn active">Sign Up</a>
                </div>
            </div>
            <!-- end: replace -->

        </div>
        <div class="nav-hamburger" id="nav-hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</nav>

<!-- ✅ PAGE HEADER -->
<section class="page-header">
    <div class="container">
        <h1 th:text="'Book: ' + ${court.courtname}">Book Sport</h1>
        <p th:text="'at ' + ${venue.venuename}"></p>
    </div>
</section>

<!-- ✅ BOOKING SECTION -->
<section class="booking-section">
    <div class="container booking-container">
        <div class="booking-steps">
            <div class="step active" data-step="1"><i class="fas fa-clock"></i> Select Slot</div>
        </div>

        <!-- STEP 1: SLOT SELECTION ONLY -->
        <div id="view-slot-selection">
            <h2 class="section-subtitle" style="text-align: left;">Choose Date and Time</h2>
            <div class="booking-details-box">
                <div class="form-group">
                    <label for="booking-date">Select Date:</label>
                    <input type="date" id="booking-date" class="form-control" required>
                    <input type="hidden" id="court-id" th:value="${court.id}">
                </div>

                <h3>Available Slots (Hourly):</h3>
                <div class="slot-selection-grid" id="slot-grid">
                    <p style="text-align:center; width:100%;">Select a date to view available slots.</p>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">
                        Total Price: <span id="total-price" th:text="'₹' + ${court.hourlyRate}">₹200</span>
                    </p>
                    <!-- ✅ Proceed Button Now Redirects to Payment Page -->
                    <button type="button" class="cta-btn" id="proceed-to-payment">
                        Proceed to Payment <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ✅ FOOTER -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-futbol"></i>
                <span>PlayPal</span>
            </div>
            <p>&copy; 2025 PlayPal. All rights reserved.</p>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    const DTO = {
        venueId: [[${venue.id}]],
        courtId: [[${court.id}]],
        venueName: '[[${venue.venuename}]]',
        courtName: '[[${court.courtname}]]',
        hourlyRate: parseFloat([[${court.hourlyRate}]]),
        csrfToken: /*[[${_csrf.token}]]*/
    };

    let bookingState = {
        selectedDate: null,
        selectedSlots: [],
        totalPrice: 0
    };

    async function loadAvailableSlots(date) {
        const slotGrid = document.getElementById('slot-grid');
        slotGrid.innerHTML = `<p>Loading available slots...</p>`;

        try {
            const courtId = document.getElementById('court-id').value;
            const response = await fetch(`/api/court-slots/available?courtId=${courtId}&date=${date}`);
            if (!response.ok) throw new Error('Failed to fetch slots');
            const slots = await response.json();

            if (slots.length === 0) {
                slotGrid.innerHTML = `<p>No slots available for this date.</p>`;
                return;
            }

            slotGrid.innerHTML = '';
            slots.forEach(slot => {
                const start = new Date(slot.startTime);
                const end = new Date(slot.endTime);
                if (slot.status !== 'AVAILABLE' || isNaN(start) || isNaN(end)) return;

                const btn = document.createElement('button');
                btn.className = 'time-slot-btn';
                btn.dataset.slot = slot.startTime;
                btn.dataset.price = DTO.hourlyRate;
                btn.textContent = `${start.getHours().toString().padStart(2, '0')}:00 - ${end.getHours().toString().padStart(2, '0')}:00`;

                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const slotTime = this.dataset.slot;

                    if (this.classList.contains('selected')) {
                        bookingState.selectedSlots.push(slotTime);
                    } else {
                        bookingState.selectedSlots = bookingState.selectedSlots.filter(s => s !== slotTime);
                    }

                    bookingState.totalPrice = bookingState.selectedSlots.length * DTO.hourlyRate;
                    document.getElementById('total-price').textContent = '₹' + bookingState.totalPrice;
                });

                slotGrid.appendChild(btn);
            });
        } catch (err) {
            console.error('Error fetching slots:', err);
            slotGrid.innerHTML = `<p>Error loading slots. Please try again later.</p>`;
        }
    }

    document.getElementById('booking-date').addEventListener('change', function() {
        bookingState.selectedDate = this.value;
        loadAvailableSlots(this.value);
    });

    document.getElementById('proceed-to-payment').addEventListener('click', async function() {
        if (!bookingState.selectedDate) {
            alert('Please select a booking date.');
            return;
        }
        if (bookingState.selectedSlots.length === 0) {
            alert('Please select at least one slot.');
            return;
        }

        // ✅ FIXED Payload
        function extractLocalTime(isoString) {
          const date = new Date(isoString);
          return date.toTimeString().split(' ')[0]; // "09:00:00"
        }

        const payload = {
          courtId: DTO.courtId,
          bookingDate: bookingState.selectedDate,
          startTime: extractLocalTime(bookingState.selectedSlots[0]),
          endTime: extractLocalTime(bookingState.selectedSlots[bookingState.selectedSlots.length - 1]),
          totalAmount: bookingState.selectedSlots.length * DTO.hourlyRate
        };





        try {
            // ✅ Step 1: Create booking with status=PENDING
            const resp = await fetch('/api/bookings/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': DTO.csrfToken
                },
                body: JSON.stringify(payload)
            });

            if (!resp.ok) throw new Error("Booking creation failed");
            const booking = await resp.json();   // should return bookingId
            const bookingId = booking.id;
            bookingState.bookingId = bookingId;

            // ✅ Step 2: Redirect to payment page
            const amount = bookingState.totalPrice;
            const selectedDate = bookingState.selectedDate;
            const slots = bookingState.selectedSlots.join(', ');
            const venueName = DTO.venueName;
            const courtName = DTO.courtName;

            window.location.href =
                `/api/payment/page?amount=${amount}` +
                `&bookingId=${bookingId}` +
                `&date=${encodeURIComponent(selectedDate)}` +
                `&slots=${encodeURIComponent(slots)}` +
                `&venueName=${encodeURIComponent(venueName)}` +
                `&courtName=${encodeURIComponent(courtName)}`;
        } catch (err) {
            console.error('❌ Booking create error:', err);
            alert('Error creating booking. Please try again.');
        }
    });


    document.addEventListener('DOMContentLoaded', async () => {
        const dateInput = document.getElementById('booking-date');
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        bookingState.selectedDate = today;
        await loadAvailableSlots(today);
    });
</script>


</body>
</html>
