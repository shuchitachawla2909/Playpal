<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Court - PlayPal</title>

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Styles needed for the JS logic that are not in style.css */
        .step {
            cursor: pointer;
        }
        .step.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <i class="fas fa-futbol"></i>
            <span>PlayPal</span>
        </div>
        <div class="nav-menu" id="nav-menu">
            <a th:href="@{/}" class="nav-link">Home</a>
            <a th:href="@{/venues}" class="nav-link active">Book</a>
            <a th:href="@{/games}" class="nav-link">Games</a>
            <a th:href="@{/about}" class="nav-link">About</a>
            <a th:href="@{/contact}" class="nav-link">Contact</a>
            <div class="nav-auth" id="nav-auth">
                <!-- When authenticated, show profile + logout -->
                <div sec:authorize="isAuthenticated()" class="mydiv">

                    <a sec:authorize="hasRole('USER')" th:href="@{/profile}" class="nav-link">
                        <img th:src="${currentUser.profilePictureUrl != null} ? ${currentUser.profilePictureUrl} : @{/images/default-avatar.jpeg}"
                             alt="Profile" class="nav-avatar">
                    </a>

                    <a sec:authorize="hasRole('MANAGER')" th:href="@{/manager/profile}" class="nav-link">
                        <img th:src="@{/images/default-avatar.jpeg}" alt="Manager Profile" class="nav-avatar">
                    </a>

                    <form th:action="@{/logout}" method="post" style="display:inline-block">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="nav-link logout-btn">
                            Logout
                        </button>
                    </form>
                </div>

                <!-- when not authenticated show login/signup -->
                <div th:unless="${authenticated}">
                    <a th:href="@{/login}" class="nav-link login-btn">Login</a>
                    <a th:href="@{/signup}" class="signup-link signup-btn active">Sign Up</a>
                </div>
            </div>
        </div>
        <div class="nav-hamburger" id="nav-hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</nav>

<section class="page-header">
    <div class="container">
        <h1 th:text="'Book: ' + ${court.courtname}">Book Sport</h1>
        <p th:text="'at ' + ${venue.venuename}"></p>
    </div>
</section>

<section class="booking-section">
    <div class="container booking-container">

        <!-- Booking Steps Indicator (Clickable via JS) -->
        <div class="booking-steps">
            <div class="step active" data-step="1" id="step-slot"><i class="fas fa-clock"></i> Select Slot</div>
            <div class="step" data-step="2" id="step-payment"><i class="fas fa-credit-card"></i> Make Payment</div>
            <div class="step" data-step="3" id="step-confirm"><i class="fas fa-check-circle"></i> Confirmation</div>
        </div>

        <!-- STEP 1: Slot Selection -->
        <div id="view-slot-selection">
            <h2 class="section-subtitle" style="text-align: left;">1. Choose Date and Time</h2>
            <div class="booking-details-box">
                <div class="form-group">
                    <label for="booking-date">Select Date:</label>
                    <input type="date" id="booking-date" class="form-control" required>
                    <input type="hidden" id="court-id" th:value="${court.id}">
                </div>

                <h3>Available Slots (Hourly):</h3>
                <div class="slot-selection-grid" id="slot-grid">
                    <p style="text-align:center; width:100%;">Select a date to view available slots.</p>
                </div>

                <div style="text-align: right; margin-top: 30px;">
                    <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">
                        Total Price: <span id="total-price" th:text="'₹' + ${court.hourlyRate}">₹200</span>
                    </p>
                    <button type="button" class="cta-btn" id="proceed-to-payment">
                        Proceed to Payment <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 2: Payment Options (Hidden by default) -->
        <div id="view-payment" style="display:none;">
            <h2 class="section-subtitle" style="text-align: left;">2. Select Payment Method</h2>

            <div class="booking-details-box">
                <p>Booking Slot: <strong id="summary-slot-time">19:00 - 20:00</strong> on <strong id="summary-slot-date">2025-10-21</strong></p>
                <p>Amount Due: <strong id="summary-payment-amount" th:text="'₹' + ${court.hourlyRate}">₹200</strong></p>

                <div class="payment-options">
                    <div class="payment-option-card" data-method="upi">
                        <i class="fas fa-qrcode fa-2x"></i>
                        <h4>UPI / GPay / PhonePe</h4>
                        <p>Instant payment via UPI apps.</p>
                    </div>
                    <div class="payment-option-card" data-method="card">
                        <i class="fas fa-credit-card fa-2x"></i>
                        <h4>Credit/Debit Card</h4>
                        <p>Visa, MasterCard, RuPay.</p>
                    </div>
                    <div class="payment-option-card" data-method="netbanking">
                        <i class="fas fa-university fa-2x"></i>
                        <h4>Net Banking</h4>
                        <p>Pay through your bank account.</p>
                    </div>
                </div>

                <button type="button" class="cta-btn confirm-btn" id="confirm-payment-btn" style="width: 100%; margin-top: 20px;" disabled>
                    <span class="btn-text">Pay <span id="payment-amount" th:text="'₹' + ${court.hourlyRate}">₹200</span></span>
                    <span class="btn-loader"><i class="fas fa-spinner fa-spin"></i> Processing...</span>
                </button>
                <button type="button" class="cancel-btn" style="width: 100%; margin-top: 10px;" onclick="navigateToStep(1)">
                    <i class="fas fa-arrow-left"></i> Go Back
                </button>
            </div>
        </div>

        <!-- STEP 3: Confirmation -->
        <div id="view-confirmation" style="display:none; text-align: center;">
            <h2 class="section-subtitle" style="text-align: center;">3. Booking Confirmed!</h2>
            <div class="booking-details-box">
                <i class="fas fa-check-circle fa-4x" style="color: var(--accent-color); margin-bottom: 20px;"></i>
                <h3>Thank you for your reservation!</h3>
                <p>Your court at <strong th:text="${venue.venuename}">Venue</strong> for <strong th:text="${court.courtname}">Sport</strong> is booked.</p>
                <p>A confirmation email has been sent.</p>
                <p>Booking ID: <strong id="confirmation-booking-id">#PENDING</strong></p>

                <a th:href="@{/profile}" class="cta-btn">View My Bookings</a>
            </div>
        </div>

    </div>
</section>

<!-- Footer (Standard structure retained) -->
<footer class="footer">
    <div class="container">
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-futbol"></i>
                <span>PlayPal</span>
            </div>
            <p>&copy; 2025 PlayPal. All rights reserved.</p>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    // --- DTO and State Initialization ---
    const DTO = {
        venueId: [[${venue.id}]],
        courtId: [[${court.id}]],
        hourlyRate: parseFloat([[${court.hourlyRate}]]),
        csrfToken: [[${_csrf.token}]]
    };

    let bookingState = {
        currentStep: 1,
        selectedDate: null,
        selectedSlot: null,
        selectedPrice: DTO.hourlyRate,
        paymentMethod: null
    };
    // ------------------------------------

    function updateStepIndicator(newStep) {
        document.querySelectorAll('.step').forEach(step => {
            const stepNum = parseInt(step.getAttribute('data-step'));
            step.classList.remove('active');
            if (stepNum === newStep) step.classList.add('active');
        });
        bookingState.currentStep = newStep;
    }

    function navigateToStep(step) {
        document.getElementById('view-slot-selection').style.display = 'none';
        document.getElementById('view-payment').style.display = 'none';
        document.getElementById('view-confirmation').style.display = 'none';

        if (step === 1) {
            document.getElementById('view-slot-selection').style.display = 'block';
        } else if (step === 2) {
            document.getElementById('summary-slot-time').textContent =
                bookingState.selectedSlot + ' - ' + (parseInt(bookingState.selectedSlot.split(':')[0]) + 1) + ':00';
            document.getElementById('summary-slot-date').textContent = bookingState.selectedDate;
            document.getElementById('view-payment').style.display = 'block';
        } else if (step === 3) {
            document.getElementById('view-confirmation').style.display = 'block';
        }
        updateStepIndicator(step);
    }

    // --- STEP 1: Slot Selection ---
    document.querySelectorAll('.time-slot-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.time-slot-btn').forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            bookingState.selectedSlot = this.getAttribute('data-slot');
            bookingState.selectedPrice = this.getAttribute('data-price');
            document.getElementById('total-price').textContent = '₹' + bookingState.selectedPrice;
            document.getElementById('payment-amount').textContent = '₹' + bookingState.selectedPrice;
        });
    });

    document.getElementById('booking-date').addEventListener('change', function() {
        bookingState.selectedDate = this.value;
    });

    document.getElementById('proceed-to-payment').addEventListener('click', function() {
        if (!bookingState.selectedDate) {
            alert('Please select a booking date.');
            return;
        }
        if (!bookingState.selectedSlot) {
            alert('Please select a slot.');
            return;
        }
        navigateToStep(2);
    });

    async function loadAvailableSlots(date) {
    const slotGrid = document.getElementById('slot-grid');
    slotGrid.innerHTML = `<p>Loading available slots...</p>`;

    try {
        const courtId = document.getElementById('court-id').value;
        const response = await fetch(`/api/court-slots/available?courtId=${courtId}&date=${date}`);

        if (!response.ok) throw new Error('Failed to fetch slots');
        const slots = await response.json();

        if (slots.length === 0) {
            slotGrid.innerHTML = `<p>No slots available for this date.</p>`;
            return;
        }

        slotGrid.innerHTML = '';
        slots.forEach(slot => {
            const start = new Date(slot.startTime);
            const end = new Date(slot.endTime);

            // Ignore invalid or already booked slots
            if (slot.status !== 'AVAILABLE' || isNaN(start) || isNaN(end)) return;

            const btn = document.createElement('button');
            btn.className = 'time-slot-btn';
            btn.dataset.slot = slot.startTime;
            btn.dataset.price = DTO.hourlyRate;
            btn.textContent = `${start.getHours().toString().padStart(2, '0')}:00 - ${end.getHours().toString().padStart(2, '0')}:00`;

            btn.addEventListener('click', function() {
                document.querySelectorAll('.time-slot-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                bookingState.selectedSlot = this.dataset.slot;
                bookingState.selectedPrice = this.dataset.price;
                document.getElementById('total-price').textContent = '₹' + bookingState.selectedPrice;
                document.getElementById('payment-amount').textContent = '₹' + bookingState.selectedPrice;
            });

            slotGrid.appendChild(btn);
        });
    } catch (err) {
        console.error('Error fetching slots:', err);
        slotGrid.innerHTML = `<p>Error loading slots. Please try again later.</p>`;
    }
}

    // --- Date Change Handler ---
    document.getElementById('booking-date').addEventListener('change', function() {
        bookingState.selectedDate = this.value;
        loadAvailableSlots(this.value);
    });


    // --- STEP 2: Payment ---
    document.querySelectorAll('.payment-option-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.payment-option-card').forEach(c => c.style.borderColor = 'var(--light-bg)');
            this.style.borderColor = 'var(--secondary-color)';
            bookingState.paymentMethod = this.getAttribute('data-method');
            document.getElementById('confirm-payment-btn').disabled = false;
        });
    });

    document.getElementById('confirm-payment-btn').addEventListener('click', async function() {
        if (!bookingState.paymentMethod) {
            alert('Please select a payment method.');
            return;
        }

        this.disabled = true;
        this.querySelector('.btn-text').style.display = 'none';
        this.querySelector('.btn-loader').style.display = 'inline';

        // Simulate payment gateway delay
        setTimeout(() => {
            const paymentRefId = 'TXN' + Math.floor(Math.random() * 1000000);
            postBookingToServer(paymentRefId);
        }, 2000);
    });

    // --- POST to Backend ---
    async function postBookingToServer(paymentRefId) {
        const start = new Date(bookingState.selectedSlot);

        // Assuming each slot is 1 hour — adjust if your slots differ
        const end = new Date(start.getTime() + 60 * 60 * 1000);

        // Convert to ISO string and trim to "YYYY-MM-DDTHH:mm:ss"
        const endTime = end.toISOString().slice(0, 19);

        const bookingData = {
            courtId: DTO.courtId,
            startTime: bookingState.selectedSlot,
            endTime: endTime,
            bookingDate: bookingState.selectedDate,
            totalAmount: bookingState.selectedPrice,
            paymentRefId: paymentRefId
        };

        try {
            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': DTO.csrfToken
                },
                body: JSON.stringify(bookingData)
            });

            if (response.ok) {
                const booking = await response.json();
                document.getElementById('confirmation-booking-id').textContent = '#' + booking.id;
                navigateToStep(3);
            } else if (response.status === 401) {
                alert('Please log in to complete your booking.');
                window.location.href = '/login';
            } else {
                alert('Booking failed. Please try again.');
            }
        } catch (error) {
            console.error('Error posting booking:', error);
            alert('Error connecting to server.');
        } finally {
            const btn = document.getElementById('confirm-payment-btn');
            btn.disabled = false;
            btn.querySelector('.btn-text').style.display = 'inline';
            btn.querySelector('.btn-loader').style.display = 'none';
        }
    }

    // --- INIT ---
document.addEventListener('DOMContentLoaded', async () => {
    const dateInput = document.getElementById('booking-date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    bookingState.selectedDate = today;

    // Load available slots dynamically for today
    await loadAvailableSlots(today);

    // Select the first slot automatically if available
    const firstSlot = document.querySelector('.time-slot-btn.selected') || document.querySelector('.time-slot-btn');
    if (firstSlot) {
        firstSlot.classList.add('selected');
        bookingState.selectedSlot = firstSlot.getAttribute('data-slot');
        bookingState.selectedPrice = firstSlot.getAttribute('data-price');
    }

    // Step navigation (kept as in your original version)
    document.getElementById('step-slot').addEventListener('click', () => navigateToStep(1));
    document.getElementById('step-payment').addEventListener('click', () => navigateToStep(2));
    document.getElementById('step-confirm').addEventListener('click', () => navigateToStep(3));
});
</script>

</body>
</html>